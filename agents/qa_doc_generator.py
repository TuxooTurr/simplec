"""
–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ—Å—Ç–æ–≤–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –¥–ª—è QA.
–í—Ö–æ–¥: —Å—ã—Ä–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ ‚Üí –í—ã—Ö–æ–¥: —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è Confluence.
"""

from __future__ import annotations

import os
import re
import time
from pathlib import Path
from typing import Optional, Dict

from dotenv import load_dotenv
from gigachat import GigaChat
from agents.llm_client import LLMClient, Message
from gigachat.models import Chat, Messages, MessagesRole

load_dotenv(Path(__file__).resolve().parent.parent / ".env")


class QADocGenerator:

    SYSTEM_PROMPT = """–¢—ã ‚Äî —Å—Ç–∞—Ä—à–∏–π QA-–∏–Ω–∂–µ–Ω–µ—Ä –≤ –∫—Ä—É–ø–Ω–æ–º –±–∞–Ω–∫–µ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Å—ã—Ä–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Ç–µ—Å—Ç–æ–≤—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è QA-–∫–æ–º–∞–Ω–¥—ã.

–§–û–†–ú–ê–¢ –í–´–í–û–î–ê ‚Äî Confluence Wiki Markup (–¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Confluence):

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –≤–∫–ª—é—á–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Ä–∞–∑–¥–µ–ª—ã:

1. **–ó–∞–≥–æ–ª–æ–≤–æ–∫** ‚Äî "–¢–µ—Å—Ç–æ–≤–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: [–Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏—á–∏]"

2. **–û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª** ‚Äî –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —á—Ç–æ –¥–µ–ª–∞–µ—Ç —Ñ–∏—á–∞:
   - –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ (—Å–ø–∏—Å–æ–∫)
   - –û–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
   - –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö

3. **–î–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É** ‚Äî –∫—Ç–æ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø, –∫–∞–∫–∏–µ —Ä–æ–ª–∏

4. **–¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞** ‚Äî –æ—Ç–∫—É–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø–∞–¥–∞–µ—Ç –≤ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

5. **API endpoints** ‚Äî —Ç–∞–±–ª–∏—Ü–∞ –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤:
   - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Ç–æ–¥–∞: –ø—É—Ç—å, –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã request/response
   - –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å, enum-–∑–Ω–∞—á–µ–Ω–∏—è
   - –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã –º–µ—Ç–æ–¥–∞

6. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** ‚Äî –µ—Å–ª–∏ –µ—Å—Ç—å: —Ç–∏–ø—ã, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –ª–æ–≥–∏–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏

7. **–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–ë–î)** ‚Äî —Ç–∞–±–ª–∏—Ü—ã, –ø–æ–ª—è, —Ç–∏–ø—ã, —Å–≤—è–∑–∏

8. **–ß–µ–∫-–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–æ–∫** ‚Äî –û–°–ù–û–í–ù–´–ï –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º:
   - –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
   - –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
   - –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
   - –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ
   –§–æ—Ä–º–∞—Ç: - [ ] –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

9. **–°–æ—Å—Ç–æ—è–Ω–∏—è UI** ‚Äî —Ç–∞–±–ª–∏—Ü–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

10. **–ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏** ‚Äî –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

11. **–°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è** ‚Äî —Ç–µ–∫—Å—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ –ø–æ—Ç–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö

–ü–†–ê–í–ò–õ–ê:
- –ò–∑–≤–ª–µ–∫–∞–π –í–°–ï API –º–µ—Ç–æ–¥—ã, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- –î–ª—è enum-–∑–Ω–∞—á–µ–Ω–∏–π —É–∫–∞–∑—ã–≤–∞–π –í–°–ï –≤–∞—Ä–∏–∞–Ω—Ç—ã
- –í —á–µ–∫-–ª–∏—Å—Ç–µ —Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –û–°–ù–û–í–ù–´–• –ø—Ä–æ–≤–µ—Ä–∫–∞—Ö (–Ω–µ –¥—É–±–ª–∏—Ä—É–π –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏)
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–æ–≤: üéØ üìç üîÑ üíæ ‚úÖ üêõ üìù
- –¢–∞–±–ª–∏—Ü—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–π —á–µ—Ä–µ–∑ | col1 | col2 | col3 |
- –í—ã–≤–æ–¥–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≥–æ—Ç–æ–≤—ã–º –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Confluence"""

    def __init__(self, auth_key: Optional[str] = None, provider: str = "gigachat"):
        self.auth_key = auth_key or os.getenv("GIGACHAT_AUTH_KEY", "")
        self.scope = os.getenv("GIGACHAT_SCOPE", "GIGACHAT_API_PERS")

        self.provider = provider
        self.llm_client = LLMClient(provider)
        
        if self.auth_key:
            self.llm = GigaChat(
                timeout=600,
                credentials=self.auth_key,
                scope=self.scope,
                verify_ssl_certs=False
            )
        else:
            self.llm = None

    def generate(self, requirement: str, feature_name: str = "") -> Dict:
        if not self.llm:
            return {
                "doc": "",
                "error": "GigaChat AUTH_KEY –Ω–µ –∑–∞–¥–∞–Ω",
                "feature_name": feature_name,
            }

        if not feature_name:
            feature_name = self._extract_feature_name(requirement)

        prompt = self._build_prompt(requirement, feature_name)
        doc = self._call_llm(prompt)

        return {
            "doc": doc,
            "feature_name": feature_name,
            "sections": self._count_sections(doc),
            "checklist_items": doc.count("- [ ]"),
        }

    def _extract_feature_name(self, text: str) -> str:
        lines = text.strip().split("\n")
        for line in lines[:10]:
            line = line.strip()
            if len(line) > 10 and len(line) < 100:
                return line
        return "–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª"

    def _build_prompt(self, requirement: str, feature_name: str) -> str:
        return (
            "–ó–ê–î–ê–ß–ê: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —Å—ã—Ä–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é "
            "—Ç–µ—Å—Ç–æ–≤—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è QA.\n\n"
            "–ù–ê–ó–í–ê–ù–ò–ï –§–ò–ß–ò: " + feature_name + "\n\n"
            "=== –°–´–†–û–ï –¢–†–ï–ë–û–í–ê–ù–ò–ï ===\n"
            + requirement + "\n\n"
            "–ò–ù–°–¢–†–£–ö–¶–ò–ò:\n"
            "1. –ò–∑–≤–ª–µ–∫–∏ –í–°–Æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è\n"
            "2. –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º –∏–∑ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞\n"
            "3. –î–ª—è API –º–µ—Ç–æ–¥–æ–≤ —É–∫–∞–∂–∏ –í–°–ï –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å —Ç–∏–ø–∞–º–∏\n"
            "4. –í —á–µ–∫-–ª–∏—Å—Ç–µ —Å–¥–µ–ª–∞–π –û–°–ù–û–í–ù–´–ï –ø—Ä–æ–≤–µ—Ä–∫–∏ (15-30 –ø—É–Ω–∫—Ç–æ–≤)\n"
            "5. –î–æ–±–∞–≤—å –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏\n"
            "6. –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞: –≥–æ—Ç–æ–≤—ã–π –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ Confluence\n\n"
            "–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é:"
        )

    def _call_llm(self, prompt: str) -> str:
        max_retries = 3
        for attempt in range(max_retries):
            try:
                response = self.llm.chat(Chat(
                    messages=[
                        Messages(role=MessagesRole.SYSTEM, content=self.SYSTEM_PROMPT),
                        Messages(role=MessagesRole.USER, content=prompt),
                    ],
                    temperature=0.2,
                    # max_tokens removed
                ))
                return response.choices[0].message.content
            except Exception as e:
                if '429' in str(e) and attempt < max_retries - 1:
                    time.sleep(2 ** attempt)
                    continue
                raise

    def _count_sections(self, doc: str) -> int:
        count = 0
        markers = [
            "–û—Å–Ω–æ–≤–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª", "–î–æ—Å—Ç—É–ø –∫ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É",
            "–¢–æ—á–∫–∏ –≤—Ö–æ–¥–∞", "API endpoints", "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è",
            "–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö", "–ß–µ–∫-–ª–∏—Å—Ç", "–°–æ—Å—Ç–æ—è–Ω–∏—è UI",
            "–ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏", "–°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è"
        ]
        lower = doc.lower()
        for m in markers:
            if m.lower() in lower:
                count += 1
        return count

